<link rel="import" href="polymer-animation.html">
<polymer-element name="polymer-animation-group" extends="polymer-animation" attributes="type">
  <script>
    (function() {
      var ANIMATION_GROUPS = {
        'par': ParGroup,
        'seq': SeqGroup
      };
      /**
       * @module Animation
       */
      /**
       * Component for a group of animations.
       *
       * @class polymer-animation-group
       */
      Polymer('polymer-animation-group', {
        /**
         * If specified the target will be assigned to all child animations.
         * @property target
         * @type HTMLElement|Node
         * @optional
         */
        targetSelector: '',
        /**
         * Group type. 'par' for parallel and 'seq' for sequence.
         * @property type
         * @type String
         */
        type: 'par',
        duration: null,
        created: function() {
          // TODO: need to do this for now.
          this.super();
        },
        typeChanged: function() {
          this.asyncApply();
        },
        targetChanged: function() {
          // Only propagate target to children animations if it's defined.
          if (this.target) {
            this.doOnChildren(function(c) {
              c.target = this.target;
            }.bind(this));
          }
        },
        doOnChildren: function(inFn) {
          var children = this.children;
          if (!children.length) {
            children = this.webkitShadowRoot ? this.webkitShadowRoot.childNodes : [];
          }
          Array.prototype.forEach.call(children, function(c) {
            // TODO <template> in the way
            c.apply && inFn(c);
          }, this);
        },
        makeAnimation: function() {
          return new ANIMATION_GROUPS[this.type](this.childAnimations, this.timingProps);
        },
        apply: function() {
          // Propagate target to child animations first.
          this.targetChanged();
          this.doOnChildren(function(c) {
            c.apply();
          });
          this.super();
        },
        completeApply: function() {
          this.doOnChildren(function(c) {
            c.completeApply();
          });
          Platform.flush();
          this.super();
        },
        get childAnimationElements() {
          var list = [];
          this.doOnChildren(function(c) {
            if (c.makeAnimation) {
              list.push(c);
            }
          });
          return list;
        },
        get childAnimations() {
          var list = [];
          this.doOnChildren(function(c) {
            if (c.animation) {
              list.push(c.animation);
            }
          });
          return list;
        }
      });
    })();
  </script>
</polymer-element>
